<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BOM Calculator</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  h1 { text-align: center; }
  input[type="text"], select { width: 200px; padding: 5px; margin-bottom: 10px; margin-right: 10px; }
  button { padding: 5px 10px; margin-left: 10px; }
  ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ccc; }
  li { padding: 5px; cursor: pointer; }
  li.selected { background-color: #add8e6; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  th { background-color: #f0f0f0; }
  label { display: inline-block; margin-bottom: 5px; }
</style>
</head>
<body>

<h1>BOM Calculator</h1>

<!-- Filtres présélection -->
<label>Qualité:
<select id="filterQualite" multiple size="3">
  <option value="gold">Gold</option>
  <option value="vio">Vio</option>
  <option value="rouge">Rouge</option>
</select>
</label>

<label>Type:
<select id="filterType" multiple size="4">
  <option value="Armes">Armes</option>
  <option value="Armures">Armures</option>
  <option value="Capes">Capes</option>
  <option value="Accessoires">Accessoires</option>
</select>
</label>

<label>Niveau:
<select id="filterNiveau" multiple size="10">
  <option value="50">50</option>
  <option value="60">60</option>
  <option value="65">65</option>
  <option value="70">70</option>
  <option value="75">75</option>
  <option value="80">80</option>
  <option value="85">85</option>
  <option value="90">90</option>
  <option value="95">95</option>
  <option value="100">100</option>
</select>
</label>

<br>

<!-- Recherche texte -->
<label>Rechercher un item : </label>
<input type="text" id="search" placeholder="Tapez un mot-clé...">

<ul id="itemList"></ul>

<button id="calculate">Calculer BOM</button>
<button id="clearSelection">Tout désélectionner</button>

<h2>Résultat Agrégé</h2>
<table id="resultTable">
  <thead>
    <tr><th>Composant</th><th>Quantité totale</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Détails par Item</h2>
<div id="details"></div>

<script>
let items = [];
let filteredItems = [];
let selectedItems = [];

// Charger le JSON
fetch("items.json")
  .then(response => response.text())
  .then(text => {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // Supprimer BOM si présent
      return JSON.parse(text);
  })
  .then(data => {
      items = data;
      filteredItems = items;
      renderList();
  })
  .catch(err => console.error("Erreur JSON :", err));

// Fonctions utilitaires
function getSelectedOptions(id) {
  const select = document.getElementById(id);
  const values = [];
  for (const option of select.options) if (option.selected) values.push(option.value);
  return values;
}

// Filtrer les items selon la recherche ET les filtres
function applyFilters() {
  const keyword = document.getElementById("search").value.toLowerCase();
  const qualites = getSelectedOptions("filterQualite");
  const types = getSelectedOptions("filterType");
  const niveaux = getSelectedOptions("filterNiveau");

  filteredItems = items.filter(it => {
    const matchesSearch = it.item.toLowerCase().includes(keyword);
    const matchesQualite = qualites.length === 0 || qualites.includes(it.qualite);
    const matchesType = types.length === 0 || types.includes(it.type);
    const matchesNiveau = niveaux.length === 0 || niveaux.includes(it.niveau);
    return matchesSearch && matchesQualite && matchesType && matchesNiveau;
  });
}

// Affichage de la liste filtrée
function renderList() {
    applyFilters();
    const ul = document.getElementById("itemList");
    ul.innerHTML = "";
    filteredItems.forEach(it => {
        const li = document.createElement("li");
        li.textContent = it.item;
        if (selectedItems.includes(it.item)) li.classList.add("selected");
        li.addEventListener("click", () => toggleSelect(it.item));
        ul.appendChild(li);
    });
}

// Sélection / désélection
function toggleSelect(itemName) {
    if (selectedItems.includes(itemName)) {
        selectedItems = selectedItems.filter(i => i !== itemName);
    } else {
        selectedItems.push(itemName);
    }
    renderList();
}

// Recherche texte
document.getElementById("search").addEventListener("input", renderList);
document.getElementById("filterQualite").addEventListener("change", renderList);
document.getElementById("filterType").addEventListener("change", renderList);
document.getElementById("filterNiveau").addEventListener("change", renderList);

// Calcul BOM
document.getElementById("calculate").addEventListener("click", function() {
    if (selectedItems.length === 0) {
        alert("Sélectionnez au moins un item !");
        return;
    }

    const allComponents = {};

    function findComponents(itemName, qty = 1, compDict = null) {
        const dict = compDict || allComponents;
        const it = items.find(i => i.item === itemName);
        if (!it) {
            if (dict[itemName]) dict[itemName] += qty;
            else dict[itemName] = qty;
            return;
        }
        for (let c = 1; c <= 3; c++) {
            const comp = it["compo" + c];
            const q = Number(it["qte" + c]);
            if (comp && comp.toUpperCase() !== "NULL") findComponents(comp, qty * (q || 1), dict);
        }
    }

    selectedItems.forEach(it => findComponents(it));

    // Affichage du tableau agrégé
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";
    for (const [comp, qty] of Object.entries(allComponents)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${comp}</td><td>${qty}</td>`;
        tbody.appendChild(tr);
    }

    // Détails par item
    const detailsDiv = document.getElementById("details");
    detailsDiv.innerHTML = "";
    selectedItems.forEach(itemName => {
        const singleComponents = {};
        findComponents(itemName, 1, singleComponents);
        const itDiv = document.createElement("div");
        itDiv.innerHTML = `<h3>Composants pour ${itemName}</h3>`;
        const table = document.createElement("table");
        table.innerHTML = "<tr><th>Composant</th><th>Quantité</th></tr>";
        for (const [comp, qty] of Object.entries(singleComponents)) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${comp}</td><td>${qty}</td>`;
            table.appendChild(tr);
        }
        itDiv.appendChild(table);
        detailsDiv.appendChild(itDiv);
    });
});

// Tout désélectionner
document.getElementById("clearSelection").addEventListener("click", function() {
    selectedItems = [];
    renderList();
});
</script>
</body>
</html>

