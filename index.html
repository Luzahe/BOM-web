<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BOM Calculator</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; /* centre tout horizontalement */
  }

  h1 { text-align: center; }

  select, input[type="text"], button { 
    padding: 5px; 
    margin: 5px 10px 5px 0; 
  }

  ul { 
    list-style: none; 
    padding: 0; 
    max-height: 300px; 
    overflow-y: auto; 
    border: 1px solid #ccc; 
    width: 400px; /* fixe la largeur */
  }

  li { 
    padding: 5px; 
    cursor: pointer; 
  }

  li.selected { 
    background-color: #add8e6; 
  }

  table { 
    border-collapse: collapse; 
    width: 80%;        /* réduit la largeur du tableau */
    max-width: 600px;  /* largeur max */
    margin-top: 20px; 
    text-align: center; 
  }

  th, td { 
    border: 1px solid #ccc; 
    padding: 5px; 
    text-align: center; 
  }

  th { 
    background-color: #f0f0f0; 
  }

  /* Centre les sections filtres, recherche et boutons */
  .filters, .search-section, #itemList, #buttons-section, #resultTable, #details {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 600px; /* limite la largeur centrale */
  }

  /* Espacement vertical */
  .filters > label, .search-section {
    margin-bottom: 10px;
  }
</style>
</head>

<body>

<h1>BOM Calculator</h1>

<!-- Filtres déroulants -->
<label>Qualité:
<select id="filterQualite">
  <option value="">-- Tous --</option>
  <option value="GOLD">Gold</option>
  <option value="VIO">Violet</option>
  <option value="ROUGE">Rouge</option>
</select>
</label>

<label>Type:
<select id="filterType">
  <option value="">-- Tous --</option>
  <option value="Armes">Armes</option>
  <option value="Armures">Armures</option>
  <option value="Capes">Capes</option>
  <option value="Accessoires">Accessoires</option>
</select>
</label>

<label>Niveau:
<select id="filterNiveau">
  <option value="">-- Tous --</option>
  <option value="50">50</option>
  <option value="60">60</option>
  <option value="65">65</option>
  <option value="70">70</option>
  <option value="75">75</option>
  <option value="80">80</option>
  <option value="85">85</option>
  <option value="90">90</option>
  <option value="95">95</option>
  <option value="100">100</option>
</select>
</label>

<br>
<label>Rechercher un item : </label>
<input type="text" id="search" placeholder="Tapez un mot-clé...">

<ul id="itemList"></ul>

<button id="selectAll">Tout sélectionner</button>
<button id="clearSelection">Tout désélectionner</button>
<button id="calculate">Calculer BOM</button>

<h2>Résultat Agrégé</h2>
<table id="resultTable">
  <thead>
    <tr><th>Composant</th><th>Quantité totale</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Détails par Item</h2>
<div id="details"></div>

<script>
let items = [];
let filteredItems = [];
let selectedItems = [];

// Charger JSON
fetch("items.json")
  .then(res => res.text())
  .then(text => {
      if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      return JSON.parse(text);
  })
  .then(data => { items = data; renderList(); })
  .catch(err => console.error("Erreur JSON :", err));

// Filtrage
function applyFilters() {
    const keyword = document.getElementById("search").value.toLowerCase();
    const qualite = document.getElementById("filterQualite").value;
    const type = document.getElementById("filterType").value;
    const niveau = document.getElementById("filterNiveau").value;

    filteredItems = items.filter(it => {
        const matchKeyword = it.item.toLowerCase().includes(keyword);
        const matchQualite = !qualite || it.qualite === qualite;
        const matchType = !type || it.type === type;
        const matchNiveau = !niveau || Number(it.niveau) === Number(niveau);
        return matchKeyword && matchQualite && matchType && matchNiveau;
    });
}

// Affichage de la liste
function renderList() {
    applyFilters();
    const ul = document.getElementById("itemList");
    ul.innerHTML = "";
    filteredItems.forEach(it => {
        const li = document.createElement("li");
        li.textContent = it.item;
        if(selectedItems.includes(it.item)) li.classList.add("selected");
        li.addEventListener("click", () => toggleSelect(it.item));
        ul.appendChild(li);
    });
}

// Sélection/désélection manuelle
function toggleSelect(itemName){
    if(selectedItems.includes(itemName)) selectedItems = selectedItems.filter(i=>i!==itemName);
    else selectedItems.push(itemName);
    renderList();
}

// Événements filtres et recherche
document.getElementById("search").addEventListener("input", renderList);
document.getElementById("filterQualite").addEventListener("change", renderList);
document.getElementById("filterType").addEventListener("change", renderList);
document.getElementById("filterNiveau").addEventListener("change", renderList);

// Bouton tout sélectionner
document.getElementById("selectAll").addEventListener("click", () => {
    filteredItems.forEach(it => {
        if(!selectedItems.includes(it.item)) selectedItems.push(it.item);
    });
    renderList();
});

// Bouton tout désélectionner
document.getElementById("clearSelection").addEventListener("click", () => {
    selectedItems=[];
    renderList();
});

// Calcul BOM
document.getElementById("calculate").addEventListener("click", function(){
    if(selectedItems.length === 0){ alert("Sélectionnez au moins un item !"); return; }
    const allComponents = {};
    function findComponents(itemName, qty=1, dict=null){
        const d = dict||allComponents;
        const it = items.find(i=>i.item===itemName);
        if(!it){ d[itemName] = (d[itemName]||0)+qty; return; }
        for(let c=1;c<=3;c++){
            const comp = it["compo"+c];
            const q = Number(it["qte"+c]);
            if(comp && comp.toUpperCase()!=="NULL") findComponents(comp, qty*(q||1), d);
        }
    }
    selectedItems.forEach(it=>findComponents(it));

    // Affichage agrégé avec case à cocher
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    // Ajouter l’en-tête pour la case à cocher
    const thead = document.querySelector("#resultTable thead tr");
    if(!thead.querySelector(".checkAll")) {
        const thCheck = document.createElement("th");
        thCheck.textContent = "Possédé";
        thCheck.classList.add("checkAll");
        thead.appendChild(thCheck);
    }

    // Trier les composants par quantité décroissante
    const sortedComponents = Object.entries(allComponents)
        .sort((a, b) => b[1] - a[1]); // tri décroissant

    // Affichage avec case
    sortedComponents.forEach(([comp, qty]) => {
        const tr = document.createElement("tr");
        const tdComp = document.createElement("td");
        tdComp.textContent = comp;
        const tdQty = document.createElement("td");
        tdQty.textContent = qty;
        const tdCheck = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        tdCheck.appendChild(checkbox);

        tr.appendChild(tdComp);
        tr.appendChild(tdQty);
        tr.appendChild(tdCheck);
        tbody.appendChild(tr);
    });



    // Détails par item
    const detailsDiv = document.getElementById("details");
    detailsDiv.innerHTML="";
    selectedItems.forEach(itemName=>{
        const singleComponents={};
        findComponents(itemName,1,singleComponents);
        const itDiv = document.createElement("div");
        itDiv.innerHTML=`<h3>Composants pour ${itemName}</h3>`;
        const table=document.createElement("table");
        table.innerHTML="<tr><th>Composant</th><th>Quantité</th></tr>";
        Object.entries(singleComponents).forEach(([comp, qty])=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${comp}</td><td>${qty}</td>`;
            table.appendChild(tr);
        });
        itDiv.appendChild(table);
        detailsDiv.appendChild(itDiv);
    });
});
</script>
</body>
</html>




